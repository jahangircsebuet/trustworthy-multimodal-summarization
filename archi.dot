digraph Idea1_RAG_Verify_Labeled_Min {
  graph [fontname="Helvetica", newrank=true, dpi=110, pad="0.2", nodesep="0.20", ranksep="0.30"];
  rankdir=TB;
  fontsize=10;
  fontname="Helvetica";
  node [shape=rect, fontsize=10, fontname="Helvetica", style="filled,rounded"];

  /* ================= Legend (TOP) ================= */
  subgraph cluster_legend {
    label="Legend (Top)";
    style="rounded,dashed"; color="#B0BEC5"; fillcolor="#FAFAFA";
    L1 [label="📥 Sources  [0]", shape=note, fillcolor="#F5F5F5"];
    L2 [label="🧩 Perception [1A–2]", shape=note, fillcolor="#E3F2FD"];
    L3 [label="🔎 Retrieval  [3–6]", shape=note, fillcolor="#EDE7F6"];
    L4 [label="✍️ Generation [7–8]", shape=note, fillcolor="#E8F5E9"];
    L5 [label="🛡️ Guards    [9–14]", shape=note, fillcolor="#FFF3E0"];
    L6 [label="📊 Evaluation [15–17]", shape=note, fillcolor="#ECEFF1"];
    { rank=source; L1; L2; L3; L4; L5; L6 }
    L1 -> L2 [style=invis, weight=50]; L2 -> L3 [style=invis, weight=50];
    L3 -> L4 [style=invis, weight=50]; L4 -> L5 [style=invis, weight=50];
    L5 -> L6 [style=invis, weight=50];
  }

  /* ================= Sources (collapsed hub) ================= */
  subgraph cluster_sources {
    label="📥 Data Sources [0]";
    style=rounded; color="#B0BEC5"; fillcolor="#F5F5F5";
    SRC [label="[0] 📥 Sources Hub", fillcolor="#FFFFFF", color="#90A4AE", shape=folder];
    T   [label="📝 Post Text",      fillcolor="#FFFFFF", color="#CFD8DC"];
    I   [label="🖼️ Images/Memes",   fillcolor="#FFFFFF", color="#CFD8DC"];
    V   [label="🎥 Short Videos",   fillcolor="#FFFFFF", color="#CFD8DC"];
    KB  [label="📚 External KB (opt.)", shape=cylinder, fillcolor="#FFFFFF", color="#CFD8DC"];
    T -> I [style=invis]; I -> V [style=invis]; V -> KB [style=invis]; KB -> SRC [style=invis];
  }

  /* ================= Perception ================= */
  subgraph cluster_perception {
    label="🧩 Perception & Normalization";
    style=rounded; color="#90CAF9"; fillcolor="#E3F2FD";
    TRN [label="[1A] 🈶 Translate → EN (opt.)",    fillcolor="#E3F2FD", color="#64B5F6"];
    OCR [label="[1B] 🔡 OCR (Tesseract/EasyOCR)",   fillcolor="#E3F2FD", color="#64B5F6"];
    CAP [label="[1C] 🖼️ Captioning (BLIP/BLIP-2)", fillcolor="#E3F2FD", color="#64B5F6"];
    ASR [label="[1D] 🎙️ ASR (Faster-Whisper)",     fillcolor="#E3F2FD", color="#64B5F6"];
    PK  [label="[2]  🧺 Pack Textbag",             fillcolor="#BBDEFB", color="#42A5F5"];
    TRN -> OCR [style=invis]; OCR -> CAP [style=invis]; CAP -> ASR [style=invis]; ASR -> PK [style=invis];
  }

  /* ================= Retrieval ================= */
  subgraph cluster_retrieval {
    label="🔎 Retrieval";
    style=rounded; color="#B39DDB"; fillcolor="#EDE7F6";
    CHK [label="[3] ✂️ Chunk to Passages",     fillcolor="#EDE7F6", color="#9575CD"];
    EMB [label="[4] 🧬 Embed (MiniLM)",        fillcolor="#EDE7F6", color="#9575CD"];
    IDX [label="[5] 📦 FAISS Index", shape=cylinder, fillcolor="#D1C4E9", color="#7E57C2"];
    RET [label="[6] 🔍 Retrieve k Snippets",   fillcolor="#D1C4E9", color="#7E57C2"];
    CHK -> EMB [style=invis]; EMB -> IDX [style=invis]; IDX -> RET [style=invis];
  }

  /* ================= Generation ================= */
  subgraph cluster_generation {
    label="✍️ Grounded Generation";
    style=rounded; color="#A5D6A7"; fillcolor="#E8F5E9";
    PR  [label="[7] 🧾 Prompt Builder\n(EVIDENCE + [refN])", fillcolor="#E8F5E9", color="#81C784"];
    GEN [label="[8] 📝 Draft Summary\n(Flan-T5)",            fillcolor="#C8E6C9", color="#66BB6A"];
    PR -> GEN [style=invis];
  }

  /* ================= Guards ================= */
  subgraph cluster_guards {
    label="🛡️ Safety Guards & Revision";
    style=rounded; color="#FFCC80"; fillcolor="#FFF3E0";
    QG  [label="[9] ❓ QG (T5)",                        fillcolor="#FFF3E0", color="#FFB74D"];
    QA  [label="[10] ✅ QA over Evidence",              fillcolor="#FFE0B2", color="#FFA726"];
    NLI [label="[11] ⚖️ NLI (MNLI)",                    fillcolor="#FFE0B2", color="#FFA726"];
    CLIP [label="[12*] 🖼️🔗 CLIP Consistency (opt.)",    fillcolor="#FFF8E1", color="#FFB74D", style="filled,rounded,dashed"];
    AGR [label="[13] 🧮 Guard Aggregation",             fillcolor="#FFE0B2", color="#FB8C00"];
    REV [label="[14] 🧽 LLM Revision",                  fillcolor="#FFCC80", color="#F57C00"];
    QG -> QA [style=invis]; QA -> NLI [style=invis]; NLI -> CLIP [style=invis]; CLIP -> AGR [style=invis]; AGR -> REV [style=invis];
  }

  /* ================= Evaluation ================= */
  subgraph cluster_eval {
    label="📊 Evaluation & Logging";
    style=rounded; color="#B0BEC5"; fillcolor="#ECEFF1";
    OUT [label="[15] ✅ Final Trusted Summary", shape=doubleoctagon, fillcolor="#CFD8DC", color="#90A4AE"];
    MET [label="[16] 📈 Metrics (ROUGE/BERT/Guard)", fillcolor="#ECEFF1", color="#90A4AE"];
    LOG [label="[17] 🗄️ Artifacts (prompts/indexes/\ndrafts/revisions/metrics)", shape=cylinder, fillcolor="#ECEFF1", color="#90A4AE"];
    OUT -> MET [style=invis]; MET -> LOG [style=invis];
  }

  /* ===== Align compact columns ===== */
  { rank=same; SRC; PK; CHK; PR; AGR; OUT }
  L3 -> SRC [style=invis, weight=100]; /* keep legend on top */

  /* ===== Main flow with concise labels ===== */
  SRC -> PK  [label="text + images + video → OCR/ASR/captions/translate → textbag", fontcolor="#455A64", color="#90A4AE"];
  PK  -> CHK [label="textbag.txt → passages", fontcolor="#1E88E5", color="#42A5F5"];
  CHK -> RET [label="passages → embeddings → FAISS → top-k", fontcolor="#5E35B1", color="#7E57C2"];
  RET -> PR  [label="evidence [ref1..N]", fontcolor="#5E35B1", color="#7E57C2"];
  PR  -> GEN [label="prompt (EVIDENCE + rules + cites)", fontcolor="#2E7D32", color="#66BB6A"];
  GEN -> AGR [label="draft s₀ (sentences + [refN])", fontcolor="#EF6C00", color="#FB8C00"];
  AGR -> REV [label="flags → edit instructions", fontcolor="#E65100", color="#F57C00"];
  REV -> OUT [label="revised s₁ (grounded, cite-clean)", fontcolor="#37474F", color="#90A4AE"];
  OUT -> MET [label="ROUGE / BERT / guard-score", fontcolor="#37474F", color="#90A4AE"];
  MET -> LOG [label="store metrics + prompts + indices + drafts", fontcolor="#37474F", color="#90A4AE"];

  /* ===== Minimal optional/context arrows (kept sparse) ===== */
  KB  -> RET  [style=dotted, color="#7E57C2", fontcolor="#5E35B1",
               label="external snippets → augment evidence"];
  I   -> CLIP [style=dashed, color="#FFB74D", fontcolor="#E65100",
               label="images/keyframes"];
  GEN -> CLIP [style=dashed, color="#FFB74D", fontcolor="#E65100",
               label="candidate sentences"];
  CLIP-> AGR  [style=dashed, color="#FFB74D", fontcolor="#E65100",
               label="image–text similarity"];
}
